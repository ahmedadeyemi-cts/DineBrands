<!DOCTYPE html>
<html>
<head>
    <title>Astute Screen Pop</title>

    <!-- Webex CC Desktop SDK -->
    <script src="https://unpkg.com/@wxcc-desktop/sdk@latest/dist/wxcc-desktop-sdk.js"></script>

    <script>
        let sdkLoaded = false;

        function safeInit() {
            // Prevent double-initialization
            if (sdkLoaded) return;
            sdkLoaded = true;

            console.log("â³ Delayed SDK init triggered");

            WxccDesktop.init()
                .then((sdk) => {
                    console.log("âœ… Webex CC SDK Loaded");
                    registerEvents(sdk);
                })
                .catch((err) => {
                    console.error("âŒ SDK init failed:", err);
                });
        }

        function registerEvents(sdk) {
            const EVENTS = [
                "interaction:connected",
                "wxcc:interaction:connected",
                "task:connected",
                "task:accepted",
                "task:assigned"
            ];

            EVENTS.forEach(evt => {
                sdk.subscribe(evt, (data) => {
                    console.log("ðŸ“ž Event Received:", evt, data);
                    tryPop(data);
                });
            });
        }

        function tryPop(event) {
            const ani = event?.data?.ani || event?.data?.fromAddress || "";
            const email =
                event?.data?.agentEmail ||
                event?.data?.userEmail ||
                event?.data?.agent?.email ||
                "";

            if (!ani || !email) {
                console.log("â³ Waiting for ANI + Agent Email...");
                return;
            }

            launchAstute(ani, email);
        }

        function launchAstute(ani, email) {
            const payload = {
                secret_key: "TrainSecret@a29m!",
                company_id: "SYS",
                b05_code: "800",
                phone: ani,
                c06_code: "0000",
                user_code_field: {
                    uxx_code: "u03_code",
                    user_code_identity: email
                }
            };

            const form = document.createElement("form");
            form.method = "POST";
            form.action = "https://USECASEPOP054A.myastutesolutions.com/api/screen";
            form.target = "_blank";

            Object.keys(payload).forEach(key => {
                if (typeof payload[key] === "object") {
                    Object.keys(payload[key]).forEach(sub => {
                        const input = document.createElement("input");
                        input.type = "hidden";
                        input.name = `user_code_field[${sub}]`;
                        input.value = payload[key][sub];
                        form.appendChild(input);
                    });
                } else {
                    const input = document.createElement("input");
                    input.type = "hidden";
                    input.name = key;
                    input.value = payload[key];
                    form.appendChild(input);
                }
            });

            document.body.appendChild(form);
            form.submit();
            form.remove();

            console.log("ðŸš€ Astute Screen Pop Launched");
        }

        // SAFETY DELAY: Initialize only after desktop is fully loaded
        window.onload = () => {
            console.log("âŒ› Waiting 2500ms before SDK init...");
            setTimeout(safeInit, 2500);
        };
    </script>
</head>

<body>
</body>
</html>
