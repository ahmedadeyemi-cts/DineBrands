<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dine Brands CasePop</title>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        text-align: center;
        transition: background-color 0.4s ease, color 0.4s ease;
    }

    body.light { background: #ffffff; color: #000; }
    body.dark  { background: #121212; color: #f5f5f5; }

    :root {
        --primary:#E31837;
        --secondary:#0078ff;
        --light-bg:#ffffff;
        --dark-bg:#121212;
        --dark-card:#1f1f1f;
    }

    .header-bar {
        position: sticky;
        top: 0;
        width: 100%;
        height: 60px;
        background: #ffffff;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-sizing: border-box;
        z-index: 1000;
    }

    body.dark .header-bar {
        background: #1f1f1f;
        border-color: #333333;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .header-logo {
        height: 32px;
    }

    .header-title {
        font-weight: bold;
        color: #333333;
    }

    body.dark .header-title {
        color: #f5f5f5;
    }

    .header-subtitle {
        font-size: 12px;
        opacity: 0.8;
    }

    .content {
        margin-top: 40px;
        padding: 0 16px 40px;
    }

    .splash-logo {
        width: 220px;
        margin-bottom: 20px;
        animation: splashLogo 0.8s ease;
    }

    @keyframes splashLogo {
        from { opacity: 0; transform: translateY(12px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    .fade {
        animation: fadeIn 0.6s ease-in-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to   { opacity: 1; transform: translateY(0); }
    }

    .spinner {
        margin: 20px auto;
        width: 50px;
        height: 50px;
        border: 6px solid #dddddd;
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .theme-toggle {
        position: fixed;
        bottom: 20px;
        left: 20px;
        width: 48px;
        height: 48px;
        background: var(--primary);
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0,0,0,0.35);
        z-index: 99999;
        transition: all 0.25s ease;
    }

    .theme-toggle img {
        width: 60%;
        height: 60%;
        object-fit: contain;
    }

    .theme-toggle:hover {
        box-shadow: 0 0 15px rgba(227, 24, 55, 0.9);
        transform: scale(1.08);
    }

    .theme-toggle::after {
        content: "Toggle Theme";
        position: absolute;
        bottom: 60px;
        left: 0;
        padding: 6px 10px;
        background: rgba(0,0,0,0.80);
        color: white;
        font-size: 12px;
        border-radius: 6px;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transform: translateY(6px);
        transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .theme-toggle:hover::after {
        opacity: 1;
        transform: translateY(0);
    }

    body.compact {
        font-size: 14px;
    }

    body.compact .header-bar {
        height: 48px;
        padding: 0 12px;
    }

    body.compact .header-logo {
        height: 26px;
    }

    body.compact .content {
        margin-top: 24px;
    }
</style>

<script>
let dinePop = null;

function applyThemeToDoc(doc, mode) {
    if (!doc || !doc.body) return;
    doc.body.classList.remove("light", "dark");
    doc.body.classList.add(mode);
}

function applyCompactToDoc(doc, on) {
    if (!doc || !doc.body) return;
    doc.body.classList.toggle("compact", on);
}

function getCurrentTheme() {
    return document.body.classList.contains("dark") ? "dark" : "light";
}

function isCompact() {
    return document.body.classList.contains("compact");
}

function loadSavedTheme() {
    const mode = localStorage.getItem("theme") || "light";
    applyThemeToDoc(document, mode);
}

function loadSavedCompact() {
    const c = localStorage.getItem("compact");
    const on = c === "on";
    applyCompactToDoc(document, on);
}

function setTheme(mode) {
    if (mode !== "dark") mode = "light";
    applyThemeToDoc(document, mode);
    localStorage.setItem("theme", mode);

    if (dinePop && !dinePop.closed) {
        applyThemeToDoc(dinePop.document, mode);
    }
}

function toggleTheme() {
    const mode = getCurrentTheme() === "dark" ? "light" : "dark";
    setTheme(mode);
}

function setCompact(on) {
    applyCompactToDoc(document, on);
    localStorage.setItem("compact", on ? "on" : "off");

    if (dinePop && !dinePop.closed) {
        applyCompactToDoc(dinePop.document, on);
    }
}

function toggleCompact() {
    setCompact(!isCompact());
}

function initPage() {
    loadSavedTheme();
    loadSavedCompact();
    runScreenPop();
}

async function runScreenPop() {
    const url = new URL(window.location.href);
    const phone = url.searchParams.get("phone");
    const email = url.searchParams.get("email");

    if (!phone || !email) {
        document.body.innerHTML = "<h2>Error: phone and email parameters are required.</h2>";
        return;
    }

    const payload = {
        secret_key:"TrainSecret@a29m!",
        company_id:"SYS",
        b05_code:"800",
        phone: phone,
        c06_code:"0000",
        user_code_field:{
            uxx_code:"u03_code",
            user_code_identity: email
        }
    };

    dinePop = window.open("about:blank", "DinePop", "width=900,height=700");

    dinePop.document.open();
    dinePop.document.write(`
        <html>
        <head>
            <title>Dine Pop</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    text-align: center;
                    transition: background-color 0.4s ease, color 0.4s ease;
                }
                body.light { background:#ffffff; color:#000; }
                body.dark  { background:#121212; color:#f5f5f5; }
                .header-bar {
                    position: sticky;
                    top: 0;
                    width: 100%;
                    height: 60px;
                    background: #ffffff;
                    border-bottom: 1px solid #e0e0e0;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 0 20px;
                    box-sizing: border-box;
                    z-index: 1000;
                }
                body.dark .header-bar {
                    background:#1f1f1f;
                    border-color:#333333;
                }
                .header-left {
                    display:flex;
                    align-items:center;
                    gap:10px;
                }
                .header-logo { height:32px; }
                .header-title { font-weight:bold; color:#333333; }
                body.dark .header-title { color:#f5f5f5; }
                .header-subtitle { font-size:12px; opacity:0.8; }
                .content {
                    margin-top:40px;
                    padding:0 16px 40px;
                }
                .splash-logo {
                    width:200px;
                    margin-bottom:20px;
                    animation:splashLogo 0.8s ease;
                }
                @keyframes splashLogo {
                    from { opacity:0; transform:translateY(12px); }
                    to   { opacity:1; transform:translateY(0); }
                }
                .fade { animation:fadeIn 0.6s ease-in-out; }
                @keyframes fadeIn {
                    from { opacity:0; transform:translateY(8px); }
                    to   { opacity:1; transform:translateY(0); }
                }
                .spinner {
                    margin:20px auto;
                    width:50px;
                    height:50px;
                    border:6px solid #dddddd;
                    border-top-color:#E31837;
                    border-radius:50%;
                    animation:spin 1s linear infinite;
                }
                @keyframes spin { to { transform:rotate(360deg); } }

                .theme-toggle {
                    position:fixed;
                    bottom:20px;
                    left:20px;
                    width:48px;
                    height:48px;
                    background:#E31837;
                    border-radius:12px;
                    display:flex;
                    align-items:center;
                    justify-content:center;
                    cursor:pointer;
                    box-shadow:0 4px 12px rgba(0,0,0,0.35);
                    z-index:99999;
                    transition:all 0.25s ease;
                }
                .theme-toggle img {
                    width:60%;
                    height:60%;
                    object-fit:contain;
                }
                .theme-toggle:hover {
                    box-shadow:0 0 15px rgba(227,24,55,0.9);
                    transform:scale(1.08);
                }
                .theme-toggle::after {
                    content:"Toggle Theme";
                    position:absolute;
                    bottom:60px;
                    left:0;
                    padding:6px 10px;
                    background:rgba(0,0,0,0.80);
                    color:white;
                    font-size:12px;
                    border-radius:6px;
                    white-space:nowrap;
                    opacity:0;
                    pointer-events:none;
                    transform:translateY(6px);
                    transition:opacity 0.25s ease, transform 0.25s ease;
                }
                .theme-toggle:hover::after {
                    opacity:1;
                    transform:translateY(0);
                }

                .settings-button {
                    position:fixed;
                    top:16px;
                    right:20px;
                    cursor:pointer;
                    font-size:22px;
                    z-index:9999;
                }

                .settings-panel {
                    position:fixed;
                    top:0;
                    right:-260px;
                    width:260px;
                    height:100%;
                    background:#ffffff;
                    color:#000;
                    box-shadow:-2px 0 10px rgba(0,0,0,0.25);
                    padding:20px;
                    box-sizing:border-box;
                    transition:right 0.3s ease;
                    z-index:9998;
                    text-align:left;
                    font-size:14px;
                }
                body.dark .settings-panel {
                    background:#1f1f1f;
                    color:#f5f5f5;
                }
                .settings-panel.open { right:0; }
                .settings-panel h3 {
                    margin-top:0;
                    margin-bottom:16px;
                }
                .settings-panel label {
                    display:flex;
                    align-items:center;
                    gap:8px;
                    margin-bottom:12px;
                }
                .settings-panel button {
                    margin-top:12px;
                    padding:6px 10px;
                    border:none;
                    background:#E31837;
                    color:white;
                    border-radius:4px;
                    cursor:pointer;
                }

                body.compact {
                    font-size:14px;
                }
                body.compact .header-bar {
                    height:48px;
                    padding:0 12px;
                }
                body.compact .header-logo {
                    height:26px;
                }
                body.compact .content {
                    margin-top:24px;
                }
            </style>
        </head>

        <body class="fade ${getCurrentTheme()} ${isCompact() ? 'compact' : ''}">

            <div class="theme-toggle" onclick="window.opener.toggleTheme()">
                <img src="https://upload.wikimedia.org/wikipedia/commons/1/1c/Dine_Brands_logo.png">
            </div>

            <div class="settings-button" onclick="openSettings()">⚙</div>

            <div id="settingsPanel" class="settings-panel">
                <h3>Settings</h3>
                <label>
                    <input type="checkbox" id="spTheme" onchange="onPanelThemeToggle()">
                    Dark mode
                </label>
                <label>
                    <input type="checkbox" id="spCompact" onchange="onPanelCompactToggle()">
                    Compact mode
                </label>
                <button onclick="closeSettings()">Close</button>
            </div>

            <div class="header-bar">
                <div class="header-left">
                    <img class="header-logo" src="https://upload.wikimedia.org/wikipedia/commons/1/1c/Dine_Brands_logo.png">
                    <span class="header-title">Dine Brands CasePop</span>
                </div>
                <div class="header-right">
                    <span class="header-subtitle">CasePop Engine</span>
                </div>
            </div>

            <div class="content">
                <img class="splash-logo" src="https://cdn.cookielaw.org/logos/de9c8170-4f8f-4c2c-bad0-0878e7e40cf0/b5704931-48da-424f-8f39-bd0abe0aca9a/e8944123-9f9c-4145-81b7-2dbb7ee9eb99/Dine_Hirez.png">
                <h2>Loading screen pop...</h2>
                <div class="spinner"></div>
                <p style="margin-top:40px; font-size:12px; opacity:0.7;">
                    Created and Maintained by Ahmed Adeyemi, US Signal, 2025
                </p>
            </div>

            <script>
                function syncSettingsFromOpener() {
                    try {
                        if (window.opener && window.opener.getCurrentTheme) {
                            var theme = window.opener.getCurrentTheme();
                            var themeCheckbox = document.getElementById("spTheme");
                            if (themeCheckbox) themeCheckbox.checked = (theme === "dark");
                        }
                        if (window.opener && window.opener.isCompact) {
                            var compact = window.opener.isCompact();
                            var compactCheckbox = document.getElementById("spCompact");
                            if (compactCheckbox) compactCheckbox.checked = compact;
                        }
                    } catch (e) {}
                }

                function openSettings() {
                    var panel = document.getElementById("settingsPanel");
                    panel.classList.add("open");
                    syncSettingsFromOpener();
                }

                function closeSettings() {
                    var panel = document.getElementById("settingsPanel");
                    panel.classList.remove("open");
                }

                function onPanelThemeToggle() {
                    var cb = document.getElementById("spTheme");
                    if (window.opener && window.opener.setTheme) {
                        window.opener.setTheme(cb.checked ? "dark" : "light");
                    }
                    syncSettingsFromOpener();
                }

                function onPanelCompactToggle() {
                    var cb = document.getElementById("spCompact");
                    if (window.opener && window.opener.setCompact) {
                        window.opener.setCompact(cb.checked);
                    }
                    syncSettingsFromOpener();
                }

                window.addEventListener("load", syncSettingsFromOpener);
            </script>

        </body>
        </html>
    `);
    dinePop.document.close();

    try {
        const response = await fetch("https://USECASEPOP054A.myastutesolutions.com/api/screen", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify(payload)
        });

        const text = await response.text();

        dinePop.document.open();
        dinePop.document.write(`
            <html>
            <head>
                <title>Dine Pop</title>
                <style>
                    body {
                        font-family:Arial, sans-serif;
                        margin:0;
                        text-align:center;
                        transition: background-color 0.4s ease, color 0.4s ease;
                    }
                    body.light { background:#ffffff; color:#000; }
                    body.dark  { background:#121212; color:#f5f5f5; }
                    .header-bar {
                        position: sticky;
                        top: 0;
                        width: 100%;
                        height: 60px;
                        background: #ffffff;
                        border-bottom: 1px solid #e0e0e0;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 0 20px;
                        box-sizing: border-box;
                        z-index: 1000;
                    }
                    body.dark .header-bar {
                        background:#1f1f1f;
                        border-color:#333333;
                    }
                    .header-left {
                        display:flex;
                        align-items:center;
                        gap:10px;
                    }
                    .header-logo { height:32px; }
                    .header-title { font-weight:bold; color:#333333; }
                    body.dark .header-title { color:#f5f5f5; }
                    .header-subtitle { font-size:12px; opacity:0.8; }
                    .content {
                        margin-top:30px;
                        padding:0 16px 40px;
                    }
                    .card {
                        max-width:850px;
                        margin:auto;
                        padding:20px;
                        border-radius:12px;
                        background:#ffffff;
                        box-shadow:0 4px 20px rgba(0,0,0,0.15);
                    }
                    body.dark .card {
                        background:#1f1f1f;
                        box-shadow:0 4px 20px rgba(255,255,255,0.15);
                    }
                    pre {
                        text-align:left;
                        white-space:pre-wrap;
                        word-break:break-word;
                        background:#ececec;
                        padding:15px;
                        border-radius:8px;
                        font-family:Consolas, monospace;
                        font-size:13px;
                    }
                    body.dark pre {
                        background:#333333;
                    }
                    .theme-toggle {
                        position:fixed;
                        bottom:20px;
                        left:20px;
                        width:48px;
                        height:48px;
                        background:#E31837;
                        border-radius:12px;
                        display:flex;
                        align-items:center;
                        justify-content:center;
                        cursor:pointer;
                        box-shadow:0 4px 12px rgba(0,0,0,0.35);
                        z-index:99999;
                        transition:all 0.25s ease;
                    }
                    .theme-toggle img {
                        width:60%;
                        height:60%;
                        object-fit:contain;
                    }
                    .theme-toggle:hover {
                        box-shadow:0 0 15px rgba(227,24,55,0.9);
                        transform:scale(1.08);
                    }
                    .theme-toggle::after {
                        content:"Toggle Theme";
                        position:absolute;
                        bottom:60px;
                        left:0;
                        padding:6px 10px;
                        background:rgba(0,0,0,0.80);
                        color:white;
                        font-size:12px;
                        border-radius:6px;
                        white-space:nowrap;
                        opacity:0;
                        pointer-events:none;
                        transform:translateY(6px);
                        transition:opacity 0.25s ease, transform 0.25s ease;
                    }
                    .theme-toggle:hover::after {
                        opacity:1;
                        transform:translateY(0);
                    }
                    .settings-button {
                        position:fixed;
                        top:16px;
                        right:20px;
                        cursor:pointer;
                        font-size:22px;
                        z-index:9999;
                    }
                    .settings-panel {
                        position:fixed;
                        top:0;
                        right:-260px;
                        width:260px;
                        height:100%;
                        background:#ffffff;
                        color:#000;
                        box-shadow:-2px 0 10px rgba(0,0,0,0.25);
                        padding:20px;
                        box-sizing:border-box;
                        transition:right 0.3s ease;
                        z-index:9998;
                        text-align:left;
                        font-size:14px;
                    }
                    body.dark .settings-panel {
                        background:#1f1f1f;
                        color:#f5f5f5;
                    }
                    .settings-panel.open { right:0; }
                    .settings-panel h3 { margin-top:0; margin-bottom:16px; }
                    .settings-panel label {
                        display:flex;
                        align-items:center;
                        gap:8px;
                        margin-bottom:12px;
                    }
                    .settings-panel button {
                        margin-top:12px;
                        padding:6px 10px;
                        border:none;
                        background:#E31837;
                        color:white;
                        border-radius:4px;
                        cursor:pointer;
                    }

                    body.compact {
                        font-size:14px;
                    }
                    body.compact .header-bar {
                        height:48px;
                        padding:0 12px;
                    }
                    body.compact .header-logo {
                        height:26px;
                    }
                    body.compact .content {
                        margin-top:20px;
                    }
                    body.compact .card {
                        padding:12px;
                    }
                </style>
            </head>

            <body class="${getCurrentTheme()} ${isCompact() ? 'compact' : ''}">

                <div class="theme-toggle" onclick="window.opener.toggleTheme()">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/1/1c/Dine_Brands_logo.png">
                </div>

                <div class="settings-button" onclick="openSettings()">⚙</div>

                <div id="settingsPanel" class="settings-panel">
                    <h3>Settings</h3>
                    <label>
                        <input type="checkbox" id="spTheme" onchange="onPanelThemeToggle()">
                        Dark mode
                    </label>
                    <label>
                        <input type="checkbox" id="spCompact" onchange="onPanelCompactToggle()">
                        Compact mode
                    </label>
                    <button onclick="closeSettings()">Close</button>
                </div>

                <div class="header-bar">
                    <div class="header-left">
                        <img class="header-logo" src="https://upload.wikimedia.org/wikipedia/commons/1/1c/Dine_Brands_logo.png">
                        <span class="header-title">Dine Brands CasePop</span>
                    </div>
                    <div class="header-right">
                        <span class="header-subtitle">CasePop Engine</span>
                    </div>
                </div>

                <div class="content">
                    <div class="card">
                        <img src="https://cdn.cookielaw.org/logos/de9c8170-4f8f-4c2c-bad0-0878e7e40cf0/b5704931-48da-424f-8f39-bd0abe0aca9a/e8944123-9f9c-4145-81b7-2dbb7ee9eb99/Dine_Hirez.png"
                             style="width:200px; margin-bottom:20px;">
                        <h2>Dine Brands Screen Pop Response</h2>
                        <pre>${text.replace(/</g, "&lt;")}</pre>
                    </div>

                    <p style="margin-top:40px; font-size:12px; opacity:0.7;">
                        Created and Maintained by Ahmed Adeyemi, US Signal, 2025
                    </p>
                </div>

                <script>
                    function syncSettingsFromOpener() {
                        try {
                            if (window.opener && window.opener.getCurrentTheme) {
                                var theme = window.opener.getCurrentTheme();
                                var themeCheckbox = document.getElementById("spTheme");
                                if (themeCheckbox) themeCheckbox.checked = (theme === "dark");
                            }
                            if (window.opener && window.opener.isCompact) {
                                var compact = window.opener.isCompact();
                                var compactCheckbox = document.getElementById("spCompact");
                                if (compactCheckbox) compactCheckbox.checked = compact;
                            }
                        } catch (e) {}
                    }

                    function openSettings() {
                        var panel = document.getElementById("settingsPanel");
                        panel.classList.add("open");
                        syncSettingsFromOpener();
                    }

                    function closeSettings() {
                        var panel = document.getElementById("settingsPanel");
                        panel.classList.remove("open");
                    }

                    function onPanelThemeToggle() {
                        var cb = document.getElementById("spTheme");
                        if (window.opener && window.opener.setTheme) {
                            window.opener.setTheme(cb.checked ? "dark" : "light");
                        }
                        syncSettingsFromOpener();
                    }

                    function onPanelCompactToggle() {
                        var cb = document.getElementById("spCompact");
                        if (window.opener && window.opener.setCompact) {
                            window.opener.setCompact(cb.checked);
                        }
                        syncSettingsFromOpener();
                    }

                    window.addEventListener("load", syncSettingsFromOpener);
                </script>

            </body>
            </html>
        `);

        dinePop.document.close();

    } catch (err) {
        dinePop.document.open();
        dinePop.document.write(`
            <html>
            <head><title>Dine Pop</title></head>
            <body>
                <h2>Request Failed</h2>
                <pre>${err}</pre>
                <p style="margin-top:40px; font-size:12px; opacity:0.7;">
                    Created and Maintained by Ahmed Adeyemi, US Signal, 2025
                </p>
            </body>
            </html>
        `);
        dinePop.document.close();
    }
}
</script>
</head>

<body onload="initPage()">

    <div class="header-bar">
        <div class="header-left">
            <img class="header-logo" src="https://upload.wikimedia.org/wikipedia/commons/1/1c/Dine_Brands_logo.png">
            <span class="header-title">Dine Brands CasePop</span>
        </div>
        <div class="header-right">
            <span class="header-subtitle">US Signal • 2025</span>
        </div>
    </div>

    <div class="content fade">
        <img class="splash-logo"
             src="https://cdn.cookielaw.org/logos/de9c8170-4f8f-4c2c-bad0-0878e7e40cf0/b5704931-48da-424f-8f39-bd0abe0aca9a/e8944123-9f9c-4145-81b7-2dbb7ee9eb99/Dine_Hirez.png">
        <h3>Processing screen pop...</h3>
        <p style="margin-top:25px; font-size:12px; opacity:0.7;">
            Created and Maintained by Ahmed Adeyemi, US Signal, 2025
        </p>
    </div>

    <div class="theme-toggle" onclick="toggleTheme()">
        <img src="https://upload.wikimedia.org/wikipedia/commons/1/1c/Dine_Brands_logo.png">
    </div>

</body>
</html>
