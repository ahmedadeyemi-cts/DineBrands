<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dine Brands CasePop</title>

<script>
async function runScreenPop() {
    // 1. Read URL parameters
    const url = new URL(window.location.href);
    const phone = url.searchParams.get("phone");
    const email = url.searchParams.get("email");

    if (!phone || !email) {
        document.body.innerHTML = "<h2>Error: phone and email parameters are required.</h2>";
        return;
    }

    // 2. Build HTTP POST Body
    const payload = {
        secret_key: "ProdSecret@a29m!",
        company_id: "SYS",
        b05_code: "800",
        phone: phone,
        c06_code: "0000",
        user_code_field: {
            uxx_code: "u03_code",
            user_code_identity: email
        }
    };

    // 3. Open new tab immediately (browsers block popups unless triggered)
    const popup = window.open("", "_blank");

    popup.document.write("<h2>Loading screen pop...</h2>");

    // 4. Execute POST call
    try {
        const response = await fetch("https://USECASEPOP054D.myastutesolutions.com/api/screen", {
            method: "POST",
            headers: { 
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        let text = await response.text();

        // 5. Pretty response in popup window
        popup.document.body.innerHTML = `
            <h2>Dine Brands Screen Pop Response</h2>
            <pre>${text.replace(/</g,"&lt;")}</pre>
        `;

    } catch (err) {
        popup.document.body.innerHTML = `
            <h2>Request Failed</h2>
            <pre>${err}</pre>
        `;
    }
}
</script>
</head>

<body onload="runScreenPop()">
<h3>Processing screen pop...</h3>
</body>
</html>
